name: Notify Slack on release

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post release to Slack
        if: ${{ vars.NOTIFY_NEW_RELEASE == 'true' }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          if [ -z "$SLACK_BOT_TOKEN" ] || [ -z "$SLACK_CHANNEL_ID" ]; then
            echo "Slack secrets missing; skipping notification."
            exit 0
          fi

          body="$(
            printf "%s" "$RELEASE_BODY" \
            | tr -d '\r' \
            | perl -pe '
                # Headings: "## Title" -> "*Title*"
                s/^##\s+(.*)$/*$1*/;

                # Bullets: "* " -> "• "
                s/^\*\s+/• /;

                # Convert markdown links [label](https://url) -> <https://url|label>
                s/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/<$2|$1>/g;

                # Convert "by @user" -> "by <https://github.com/user|@user>"
                s/\bby\s+\@([A-Za-z0-9-]+)/by <https:\/\/github.com\/$1|\@$1>/g;

                # Convert "in https://.../pull/123" -> "(<...|PR #123>)"  (NO EXTRA QUOTES)
                s/\s+in\s+(https:\/\/github\.com\/[^\/\s]+\/[^\/\s]+\/pull\/(\d+))/ (PR <$1|#$2>)/g;

                # Full changelog line -> link label only
                s/^\*\*Full Changelog\*\*:\s*(https?:\/\/\S+)$/<$1|Full changelog>/i;
              ' \
            | head -c 2800
          )"

          title="${RELEASE_NAME:-$RELEASE_TAG}"

          # Release title as a link; remove "View release" line
          text="$(printf "*Release:* <%s|%s>\n\n%s" \
            "$RELEASE_URL" "$title" "$body"
          )"

          payload="$(jq -n \
            --arg channel "$SLACK_CHANNEL_ID" \
            --arg text "$text" \
            '{
              channel: $channel,
              text: $text,
              mrkdwn: true,
              unfurl_links: false,
              unfurl_media: false
            }'
          )"

          curl -sS -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "$payload" | jq
